name: SNS Post Notification

on:
  workflow_dispatch:
    inputs:
      date:
        description: 'Target date (YYYY-MM-DD, empty for today)'
        required: false
        type: string
      channel:
        description: 'Slack channel ID'
        required: false
        default: 'C0AB6SU4HUZ'
        type: string

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Get current date (JST)
        id: date
        run: |
          if [ -n "${{ inputs.date }}" ]; then
            echo "today=${{ inputs.date }}" >> $GITHUB_OUTPUT
          else
            echo "today=$(TZ='Asia/Tokyo' date '+%Y-%m-%d')" >> $GITHUB_OUTPUT
          fi

      - name: Fetch schedule from data repo
        id: schedule
        env:
          GH_TOKEN: ${{ secrets.DATA_REPO_PAT }}
        run: |
          # Fetch schedule.md
          SCHEDULE=$(curl -sH "Authorization: token $GH_TOKEN" \
            "https://raw.githubusercontent.com/takuya86/obsidian-sns-data/main/schedule.md")

          # Find today's post
          TODAY="${{ steps.date.outputs.today }}"
          LINE=$(echo "$SCHEDULE" | grep "^| $TODAY" || true)

          if [ -z "$LINE" ]; then
            echo "No post scheduled for today ($TODAY)"
            echo "found=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Extract title from schedule line
          TITLE=$(echo "$LINE" | awk -F'|' '{print $3}' | xargs)
          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "found=true" >> $GITHUB_OUTPUT

      - name: Clone data repo with LFS
        if: steps.schedule.outputs.found == 'true'
        env:
          GH_TOKEN: ${{ secrets.DATA_REPO_PAT }}
        run: |
          git lfs install
          git clone --depth 1 "https://$GH_TOKEN@github.com/takuya86/obsidian-sns-data.git" data-repo
          cd data-repo
          git lfs pull

      - name: Fetch captions
        if: steps.schedule.outputs.found == 'true'
        id: captions
        run: |
          TITLE="${{ steps.schedule.outputs.title }}"

          # Read captions.md
          CAPTIONS=$(cat "data-repo/videos/$TITLE/captions.md")

          # Extract TikTok caption
          TIKTOK_CAPTION=$(echo "$CAPTIONS" | sed -n '/## TikTok/,/## /p' | head -n -1 | tail -n +2)
          {
            echo "tiktok<<EOF"
            echo "$TIKTOK_CAPTION"
            echo "EOF"
          } >> $GITHUB_OUTPUT

          # Extract Instagram caption
          INSTAGRAM_CAPTION=$(echo "$CAPTIONS" | sed -n '/## Instagram/,/## /p' | head -n -1 | tail -n +2)
          {
            echo "instagram<<EOF"
            echo "$INSTAGRAM_CAPTION"
            echo "EOF"
          } >> $GITHUB_OUTPUT

          # Extract X caption
          X_CAPTION=$(echo "$CAPTIONS" | sed -n '/## XÊäïÁ®øÊñá/,/## /p' | head -n -1 | tail -n +2)
          if [ -z "$X_CAPTION" ]; then
            X_CAPTION=$(echo "$CAPTIONS" | sed -n '/## XÊäïÁ®øÊñá/,$p' | tail -n +2)
          fi
          {
            echo "x<<EOF"
            echo "$X_CAPTION"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Upload TikTok video to Slack
        if: steps.schedule.outputs.found == 'true'
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
        run: |
          TITLE="${{ steps.schedule.outputs.title }}"
          CHANNEL="${{ inputs.channel }}"
          TODAY="${{ steps.date.outputs.today }}"
          VIDEO_PATH="data-repo/videos/$TITLE/tiktok.mp4"
          FILENAME="${TODAY}_tiktok.mp4"
          FILESIZE=$(stat -c%s "$VIDEO_PATH")

          # Step 1: Get upload URL
          UPLOAD_URL_RESPONSE=$(curl -s -X POST \
            -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
            -H "Content-type: application/x-www-form-urlencoded" \
            --data-urlencode "filename=$FILENAME" \
            --data-urlencode "length=$FILESIZE" \
            "https://slack.com/api/files.getUploadURLExternal")

          UPLOAD_URL=$(echo "$UPLOAD_URL_RESPONSE" | jq -r '.upload_url')
          FILE_ID=$(echo "$UPLOAD_URL_RESPONSE" | jq -r '.file_id')

          # Step 2: Upload file
          curl -s -X POST "$UPLOAD_URL" -F "file=@$VIDEO_PATH"

          # Step 3: Complete upload
          curl -s -X POST \
            -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
            -H "Content-type: application/json" \
            --data "{\"files\":[{\"id\":\"$FILE_ID\",\"title\":\"üéµ TikTok: $TITLE\"}],\"channel_id\":\"$CHANNEL\"}" \
            "https://slack.com/api/files.completeUploadExternal"

      - name: Upload Instagram video to Slack
        if: steps.schedule.outputs.found == 'true'
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
        run: |
          TITLE="${{ steps.schedule.outputs.title }}"
          CHANNEL="${{ inputs.channel }}"
          TODAY="${{ steps.date.outputs.today }}"
          VIDEO_PATH="data-repo/videos/$TITLE/instagram.mp4"
          FILENAME="${TODAY}_instagram.mp4"
          FILESIZE=$(stat -c%s "$VIDEO_PATH")

          # Step 1: Get upload URL
          UPLOAD_URL_RESPONSE=$(curl -s -X POST \
            -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
            -H "Content-type: application/x-www-form-urlencoded" \
            --data-urlencode "filename=$FILENAME" \
            --data-urlencode "length=$FILESIZE" \
            "https://slack.com/api/files.getUploadURLExternal")

          UPLOAD_URL=$(echo "$UPLOAD_URL_RESPONSE" | jq -r '.upload_url')
          FILE_ID=$(echo "$UPLOAD_URL_RESPONSE" | jq -r '.file_id')

          # Step 2: Upload file
          curl -s -X POST "$UPLOAD_URL" -F "file=@$VIDEO_PATH"

          # Step 3: Complete upload
          curl -s -X POST \
            -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
            -H "Content-type: application/json" \
            --data "{\"files\":[{\"id\":\"$FILE_ID\",\"title\":\"üì∏ Instagram: $TITLE\"}],\"channel_id\":\"$CHANNEL\"}" \
            "https://slack.com/api/files.completeUploadExternal"

      - name: Send Slack summary message
        if: steps.schedule.outputs.found == 'true'
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
        run: |
          TITLE="${{ steps.schedule.outputs.title }}"
          TODAY="${{ steps.date.outputs.today }}"
          CHANNEL="${{ inputs.channel }}"

          TIKTOK_CAPTION='${{ steps.captions.outputs.tiktok }}'
          INSTAGRAM_CAPTION='${{ steps.captions.outputs.instagram }}'
          X_CAPTION='${{ steps.captions.outputs.x }}'

          # Build Slack message with jq
          PAYLOAD=$(jq -n \
            --arg channel "$CHANNEL" \
            --arg today "$TODAY" \
            --arg title "$TITLE" \
            --arg tiktok "$TIKTOK_CAPTION" \
            --arg instagram "$INSTAGRAM_CAPTION" \
            --arg x "$X_CAPTION" \
            '{
              channel: $channel,
              blocks: [
                {
                  type: "header",
                  text: {
                    type: "plain_text",
                    text: "üì¢ SNSÊäïÁ®ø„ÅÆÊôÇÈñì„Åß„ÅôÔºÅ",
                    emoji: true
                  }
                },
                {
                  type: "section",
                  fields: [
                    { type: "mrkdwn", text: "*Êó•‰ªò:*\n\($today)" },
                    { type: "mrkdwn", text: "*„Çø„Ç§„Éà„É´:*\n\($title)" }
                  ]
                },
                { type: "divider" },
                {
                  type: "section",
                  text: { type: "mrkdwn", text: "*üéµ TikTok„Ç≠„É£„Éó„Ç∑„Éß„É≥:*\n```\($tiktok)```" }
                },
                { type: "divider" },
                {
                  type: "section",
                  text: { type: "mrkdwn", text: "*üì∏ Instagram„Ç≠„É£„Éó„Ç∑„Éß„É≥:*\n```\($instagram)```" }
                },
                { type: "divider" },
                {
                  type: "section",
                  text: { type: "mrkdwn", text: "*üê¶ XÊäïÁ®øÊñá:*\n```\($x)```" }
                }
              ]
            }')

          curl -s -X POST \
            -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
            -H "Content-type: application/json" \
            --data "$PAYLOAD" \
            "https://slack.com/api/chat.postMessage"
