name: SNS Post Notification

on:
  workflow_dispatch:
    inputs:
      platform:
        description: 'Platform to post (tiktok or instagram)'
        required: true
        default: 'tiktok'
        type: choice
        options:
          - tiktok
          - instagram
      date:
        description: 'Target date (YYYY-MM-DD, empty for today)'
        required: false
        type: string
      channel:
        description: 'Slack channel ID'
        required: false
        default: 'C0AB6SU4HUZ'
        type: string

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Get current date (JST)
        id: date
        run: |
          if [ -n "${{ inputs.date }}" ]; then
            echo "today=${{ inputs.date }}" >> $GITHUB_OUTPUT
          else
            echo "today=$(TZ='Asia/Tokyo' date '+%Y-%m-%d')" >> $GITHUB_OUTPUT
          fi

      - name: Fetch schedule from data repo
        id: schedule
        env:
          GH_TOKEN: ${{ secrets.DATA_REPO_PAT }}
        run: |
          # Fetch schedule.md
          SCHEDULE=$(curl -sH "Authorization: token $GH_TOKEN" \
            "https://raw.githubusercontent.com/takuya86/obsidian-sns-data/main/schedule.md")

          # Find today's post
          TODAY="${{ steps.date.outputs.today }}"
          LINE=$(echo "$SCHEDULE" | grep "^| $TODAY" || true)

          if [ -z "$LINE" ]; then
            echo "No post scheduled for today ($TODAY)"
            echo "found=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Extract title from schedule line
          TITLE=$(echo "$LINE" | awk -F'|' '{print $3}' | xargs)
          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "found=true" >> $GITHUB_OUTPUT

      - name: Clone data repo with LFS
        if: steps.schedule.outputs.found == 'true'
        env:
          GH_TOKEN: ${{ secrets.DATA_REPO_PAT }}
        run: |
          git lfs install
          git clone --depth 1 "https://$GH_TOKEN@github.com/takuya86/obsidian-sns-data.git" data-repo
          cd data-repo
          git lfs pull

      - name: Fetch captions
        if: steps.schedule.outputs.found == 'true'
        id: captions
        run: |
          TITLE="${{ steps.schedule.outputs.title }}"
          PLATFORM="${{ inputs.platform }}"

          # Read captions.md
          CAPTIONS=$(cat "data-repo/videos/$TITLE/captions.md")

          # Extract platform-specific caption
          if [ "$PLATFORM" = "tiktok" ]; then
            CAPTION=$(echo "$CAPTIONS" | sed -n '/## TikTok/,/## /p' | head -n -1 | tail -n +2)
          else
            CAPTION=$(echo "$CAPTIONS" | sed -n '/## Instagram/,/## /p' | head -n -1 | tail -n +2)
          fi

          # Store caption (handle multiline)
          {
            echo "caption<<EOF"
            echo "$CAPTION"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Upload video to Slack
        if: steps.schedule.outputs.found == 'true'
        id: upload
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
        run: |
          TITLE="${{ steps.schedule.outputs.title }}"
          PLATFORM="${{ inputs.platform }}"
          CHANNEL="${{ inputs.channel }}"
          TODAY="${{ steps.date.outputs.today }}"
          VIDEO_PATH="data-repo/videos/$TITLE/$PLATFORM.mp4"
          FILENAME="${TODAY}_${PLATFORM}.mp4"
          FILESIZE=$(stat -c%s "$VIDEO_PATH")

          # Step 1: Get upload URL
          UPLOAD_URL_RESPONSE=$(curl -s -X POST \
            -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
            -H "Content-type: application/x-www-form-urlencoded" \
            --data-urlencode "filename=$FILENAME" \
            --data-urlencode "length=$FILESIZE" \
            "https://slack.com/api/files.getUploadURLExternal")

          echo "Upload URL response: $UPLOAD_URL_RESPONSE"

          UPLOAD_URL=$(echo "$UPLOAD_URL_RESPONSE" | jq -r '.upload_url')
          FILE_ID=$(echo "$UPLOAD_URL_RESPONSE" | jq -r '.file_id')

          if [ "$UPLOAD_URL" = "null" ]; then
            echo "Failed to get upload URL"
            exit 1
          fi

          # Step 2: Upload file to the URL
          curl -s -X POST "$UPLOAD_URL" \
            -F "file=@$VIDEO_PATH"

          # Step 3: Complete the upload
          COMPLETE_RESPONSE=$(curl -s -X POST \
            -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
            -H "Content-type: application/json" \
            --data "{\"files\":[{\"id\":\"$FILE_ID\",\"title\":\"$TODAY - $TITLE ($PLATFORM)\"}],\"channel_id\":\"$CHANNEL\",\"initial_comment\":\"ðŸ“¹ å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«\"}" \
            "https://slack.com/api/files.completeUploadExternal")

          echo "Complete response: $COMPLETE_RESPONSE"

          OK=$(echo "$COMPLETE_RESPONSE" | jq -r '.ok')
          if [ "$OK" != "true" ]; then
            echo "Failed to complete upload"
            echo "$COMPLETE_RESPONSE" | jq .
            exit 1
          fi

      - name: Send Slack message
        if: steps.schedule.outputs.found == 'true'
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
        run: |
          PLATFORM="${{ inputs.platform }}"
          TITLE="${{ steps.schedule.outputs.title }}"
          TODAY="${{ steps.date.outputs.today }}"
          CHANNEL="${{ inputs.channel }}"

          # Escape caption for JSON
          CAPTION=$(cat <<'CAPTIONEOF'
          ${{ steps.captions.outputs.caption }}
          CAPTIONEOF
          )

          if [ "$PLATFORM" = "tiktok" ]; then
            EMOJI=":musical_note:"
            TIME="12:00"
          else
            EMOJI=":camera:"
            TIME="19:00"
          fi

          # Build Slack message
          PAYLOAD=$(jq -n \
            --arg channel "$CHANNEL" \
            --arg emoji "$EMOJI" \
            --arg platform "$PLATFORM" \
            --arg today "$TODAY" \
            --arg time "$TIME" \
            --arg title "$TITLE" \
            --arg caption "$CAPTION" \
            '{
              channel: $channel,
              blocks: [
                {
                  type: "header",
                  text: {
                    type: "plain_text",
                    text: "\($emoji) \($platform) æŠ•ç¨¿æ™‚é–“ã§ã™ï¼",
                    emoji: true
                  }
                },
                {
                  type: "section",
                  fields: [
                    { type: "mrkdwn", text: "*æ—¥ä»˜:*\n\($today)" },
                    { type: "mrkdwn", text: "*æŠ•ç¨¿æ™‚é–“:*\n\($time) JST" }
                  ]
                },
                {
                  type: "section",
                  text: { type: "mrkdwn", text: "*ã‚¿ã‚¤ãƒˆãƒ«:*\n\($title)" }
                },
                { type: "divider" },
                {
                  type: "section",
                  text: { type: "mrkdwn", text: "*ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³:*\n```\($caption)```" }
                }
              ]
            }')

          # Send message
          curl -s -X POST \
            -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
            -H "Content-type: application/json" \
            --data "$PAYLOAD" \
            "https://slack.com/api/chat.postMessage"
