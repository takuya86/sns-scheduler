name: SNS Post Notification

on:
  schedule:
    - cron: '0 3 * * *'   # 12:00 JST ‚Üí TikTok
    - cron: '0 10 * * *'  # 19:00 JST ‚Üí Instagram
  workflow_dispatch:
    inputs:
      date:
        description: 'Target date (YYYY-MM-DD, empty for today)'
        required: false
        type: string
      row:
        description: 'Row number for same-date entries (1, 2, 3...)'
        required: false
        default: '1'
        type: string
      channel:
        description: 'Slack channel ID'
        required: false
        default: 'C0AB6SU4HUZ'
        type: string

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Get current date (JST)
        id: date
        run: |
          if [ -n "${{ inputs.date }}" ]; then
            echo "today=${{ inputs.date }}" >> $GITHUB_OUTPUT
          else
            echo "today=$(TZ='Asia/Tokyo' date '+%Y-%m-%d')" >> $GITHUB_OUTPUT
          fi

      - name: Determine platform
        id: platform
        run: |
          if [ "${{ github.event_name }}" = "schedule" ]; then
            HOUR=$(TZ='Asia/Tokyo' date '+%H')
            if [ "$HOUR" = "12" ]; then
              echo "tiktok=true" >> $GITHUB_OUTPUT
              echo "instagram=false" >> $GITHUB_OUTPUT
            elif [ "$HOUR" = "19" ]; then
              echo "tiktok=false" >> $GITHUB_OUTPUT
              echo "instagram=true" >> $GITHUB_OUTPUT
            fi
          else
            echo "tiktok=true" >> $GITHUB_OUTPUT
            echo "instagram=true" >> $GITHUB_OUTPUT
          fi

      - name: Fetch schedule from data repo
        id: schedule
        env:
          GH_TOKEN: ${{ secrets.DATA_REPO_PAT }}
        run: |
          # Fetch schedule.md
          SCHEDULE=$(curl -sH "Authorization: token $GH_TOKEN" \
            "https://raw.githubusercontent.com/takuya86/obsidian-sns-data/main/schedule.md")

          # Find today's post (specific row for same-date entries)
          TODAY="${{ steps.date.outputs.today }}"
          ROW="${{ inputs.row }}"
          ROW="${ROW:-1}"
          LINE=$(echo "$SCHEDULE" | grep "^| $TODAY" | sed -n "${ROW}p" || true)

          if [ -z "$LINE" ]; then
            echo "No post scheduled for today ($TODAY)"
            echo "found=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Extract title from schedule line
          TITLE=$(echo "$LINE" | awk -F'|' '{print $3}' | xargs)
          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "found=true" >> $GITHUB_OUTPUT

      - name: Clone data repo
        if: steps.schedule.outputs.found == 'true'
        env:
          GH_TOKEN: ${{ secrets.DATA_REPO_PAT }}
        run: |
          git clone --depth 1 "https://$GH_TOKEN@github.com/takuya86/obsidian-sns-data.git" data-repo

      - name: Fetch captions
        if: steps.schedule.outputs.found == 'true'
        id: captions
        run: |
          TITLE="${{ steps.schedule.outputs.title }}"

          # Read captions.md
          CAPTIONS=$(cat "data-repo/videos/$TITLE/captions.md")

          # Extract TikTok caption
          TIKTOK_CAPTION=$(echo "$CAPTIONS" | sed -n '/## TikTok/,/## /p' | head -n -1 | tail -n +2)
          {
            echo "tiktok<<EOF"
            echo "$TIKTOK_CAPTION"
            echo "EOF"
          } >> $GITHUB_OUTPUT

          # Extract Instagram caption
          INSTAGRAM_CAPTION=$(echo "$CAPTIONS" | sed -n '/## Instagram/,/## /p' | head -n -1 | tail -n +2)
          {
            echo "instagram<<EOF"
            echo "$INSTAGRAM_CAPTION"
            echo "EOF"
          } >> $GITHUB_OUTPUT

          # Extract X caption
          X_CAPTION=$(echo "$CAPTIONS" | sed -n '/## XÊäïÁ®øÊñá/,/## /p' | head -n -1 | tail -n +2)
          if [ -z "$X_CAPTION" ]; then
            X_CAPTION=$(echo "$CAPTIONS" | sed -n '/## XÊäïÁ®øÊñá/,$p' | tail -n +2)
          fi
          {
            echo "x<<EOF"
            echo "$X_CAPTION"
            echo "EOF"
          } >> $GITHUB_OUTPUT

          # Extract ThreadsÔºànoteË™òÂ∞éÔºâcaption
          THREADS_NOTE=$(echo "$CAPTIONS" | sed -n '/## ThreadsÔºànoteË™òÂ∞éÔºâ/,/## /p' | head -n -1 | tail -n +2)
          if [ -z "$THREADS_NOTE" ]; then
            THREADS_NOTE=$(echo "$CAPTIONS" | sed -n '/## ThreadsÔºànoteË™òÂ∞éÔºâ/,$p' | tail -n +2)
          fi
          {
            echo "threads_note<<EOF"
            echo "$THREADS_NOTE"
            echo "EOF"
          } >> $GITHUB_OUTPUT

          # Extract ThreadsÔºà„Ç¢„Éï„Ç£„É™„Ç®„Ç§„ÉàÔºâcaption
          THREADS_AFFI=$(echo "$CAPTIONS" | sed -n '/## ThreadsÔºà„Ç¢„Éï„Ç£„É™„Ç®„Ç§„ÉàÔºâ/,/## /p' | head -n -1 | tail -n +2)
          if [ -z "$THREADS_AFFI" ]; then
            THREADS_AFFI=$(echo "$CAPTIONS" | sed -n '/## ThreadsÔºà„Ç¢„Éï„Ç£„É™„Ç®„Ç§„ÉàÔºâ/,$p' | tail -n +2)
          fi
          {
            echo "threads_affi<<EOF"
            echo "$THREADS_AFFI"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Upload TikTok video to Slack
        if: steps.schedule.outputs.found == 'true' && steps.platform.outputs.tiktok == 'true'
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
        run: |
          TITLE="${{ steps.schedule.outputs.title }}"
          CHANNEL="${{ inputs.channel }}"
          CHANNEL="${CHANNEL:-C0AB6SU4HUZ}"
          TODAY="${{ steps.date.outputs.today }}"
          VIDEO_PATH="data-repo/videos/$TITLE/tiktok.mp4"
          FILENAME="${TODAY}_tiktok.mp4"
          FILESIZE=$(stat -c%s "$VIDEO_PATH")

          # Step 1: Get upload URL
          UPLOAD_URL_RESPONSE=$(curl -s -X POST \
            -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
            -H "Content-type: application/x-www-form-urlencoded" \
            --data-urlencode "filename=$FILENAME" \
            --data-urlencode "length=$FILESIZE" \
            "https://slack.com/api/files.getUploadURLExternal")

          UPLOAD_URL=$(echo "$UPLOAD_URL_RESPONSE" | jq -r '.upload_url')
          FILE_ID=$(echo "$UPLOAD_URL_RESPONSE" | jq -r '.file_id')

          # Step 2: Upload file
          curl -s -X POST "$UPLOAD_URL" -F "file=@$VIDEO_PATH"

          # Step 3: Complete upload
          curl -s -X POST \
            -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
            -H "Content-type: application/json" \
            --data "{\"files\":[{\"id\":\"$FILE_ID\",\"title\":\"üéµ TikTok: $TITLE\"}],\"channel_id\":\"$CHANNEL\"}" \
            "https://slack.com/api/files.completeUploadExternal"

      - name: Send TikTok caption
        if: steps.schedule.outputs.found == 'true' && steps.platform.outputs.tiktok == 'true'
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
        run: |
          CHANNEL="${{ inputs.channel }}"
          CHANNEL="${CHANNEL:-C0AB6SU4HUZ}"
          TIKTOK_CAPTION='${{ steps.captions.outputs.tiktok }}'

          # „Éè„ÉÉ„Ç∑„É•„Çø„Ç∞„ÅÆÂâç„Å´@riko_renai_advice„ÇíÊåøÂÖ•
          # ÊúÄÂàù„ÅÆ#„ÅÆÂâç„Å´@riko_renai_advice„ÇíËøΩÂä†
          TIKTOK_WITH_MENTION=$(echo "$TIKTOK_CAPTION" | sed 's/#/@riko_renai_advice\n\n#/1')

          curl -s -X POST \
            -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
            -H "Content-type: application/json" \
            --data "$(jq -n --arg channel "$CHANNEL" --arg text "$TIKTOK_WITH_MENTION" '{channel: $channel, text: $text}')" \
            "https://slack.com/api/chat.postMessage"

      - name: Upload Instagram video to Slack
        if: steps.schedule.outputs.found == 'true' && steps.platform.outputs.instagram == 'true'
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
        run: |
          TITLE="${{ steps.schedule.outputs.title }}"
          CHANNEL="${{ inputs.channel }}"
          CHANNEL="${CHANNEL:-C0AB6SU4HUZ}"
          TODAY="${{ steps.date.outputs.today }}"
          VIDEO_PATH="data-repo/videos/$TITLE/instagram.mp4"
          FILENAME="${TODAY}_instagram.mp4"
          FILESIZE=$(stat -c%s "$VIDEO_PATH")

          # Step 1: Get upload URL
          UPLOAD_URL_RESPONSE=$(curl -s -X POST \
            -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
            -H "Content-type: application/x-www-form-urlencoded" \
            --data-urlencode "filename=$FILENAME" \
            --data-urlencode "length=$FILESIZE" \
            "https://slack.com/api/files.getUploadURLExternal")

          UPLOAD_URL=$(echo "$UPLOAD_URL_RESPONSE" | jq -r '.upload_url')
          FILE_ID=$(echo "$UPLOAD_URL_RESPONSE" | jq -r '.file_id')

          # Step 2: Upload file
          curl -s -X POST "$UPLOAD_URL" -F "file=@$VIDEO_PATH"

          # Step 3: Complete upload
          curl -s -X POST \
            -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
            -H "Content-type: application/json" \
            --data "{\"files\":[{\"id\":\"$FILE_ID\",\"title\":\"üì∏ Instagram: $TITLE\"}],\"channel_id\":\"$CHANNEL\"}" \
            "https://slack.com/api/files.completeUploadExternal"

      - name: Send Instagram caption
        if: steps.schedule.outputs.found == 'true' && steps.platform.outputs.instagram == 'true'
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
        run: |
          CHANNEL="${{ inputs.channel }}"
          CHANNEL="${CHANNEL:-C0AB6SU4HUZ}"
          INSTAGRAM_CAPTION='${{ steps.captions.outputs.instagram }}'

          curl -s -X POST \
            -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
            -H "Content-type: application/json" \
            --data "$(jq -n --arg channel "$CHANNEL" --arg text "$INSTAGRAM_CAPTION" '{channel: $channel, text: $text}')" \
            "https://slack.com/api/chat.postMessage"

      - name: Send Threads caption (noteË™òÂ∞é)
        if: steps.schedule.outputs.found == 'true' && steps.platform.outputs.tiktok == 'true'
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
        run: |
          CHANNEL="${{ inputs.channel }}"
          CHANNEL="${CHANNEL:-C0AB6SU4HUZ}"
          CAPTION='${{ steps.captions.outputs.threads_note }}'
          if [ -n "$CAPTION" ]; then
            TITLE="${{ steps.schedule.outputs.title }}"
            TEXT="üßµ ThreadsÔºànoteË™òÂ∞éÔºâ: ${TITLE}"$'\n'"${CAPTION}"
            curl -s -X POST \
              -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
              -H "Content-type: application/json" \
              --data "$(jq -n \
                --arg channel "$CHANNEL" \
                --arg text "$TEXT" \
                '{channel: $channel, text: $text}')" \
              "https://slack.com/api/chat.postMessage"
          fi

      - name: Send Threads caption („Ç¢„Éï„Ç£„É™„Ç®„Ç§„Éà)
        if: steps.schedule.outputs.found == 'true' && steps.platform.outputs.tiktok == 'true'
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
        run: |
          CHANNEL="${{ inputs.channel }}"
          CHANNEL="${CHANNEL:-C0AB6SU4HUZ}"
          CAPTION='${{ steps.captions.outputs.threads_affi }}'
          if [ -n "$CAPTION" ]; then
            TITLE="${{ steps.schedule.outputs.title }}"
            TEXT="üßµ ThreadsÔºà„Ç¢„Éï„Ç£„É™„Ç®„Ç§„ÉàÔºâ: ${TITLE}"$'\n'"${CAPTION}"
            curl -s -X POST \
              -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
              -H "Content-type: application/json" \
              --data "$(jq -n \
                --arg channel "$CHANNEL" \
                --arg text "$TEXT" \
                '{channel: $channel, text: $text}')" \
              "https://slack.com/api/chat.postMessage"
          fi
