name: SNS Post Notification

on:
  workflow_dispatch:
    inputs:
      platform:
        description: 'Platform to post (tiktok or instagram)'
        required: true
        default: 'tiktok'
        type: choice
        options:
          - tiktok
          - instagram

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Get current date (JST)
        id: date
        run: |
          echo "today=$(TZ='Asia/Tokyo' date '+%Y-%m-%d')" >> $GITHUB_OUTPUT

      - name: Fetch schedule from data repo
        id: schedule
        env:
          GH_TOKEN: ${{ secrets.DATA_REPO_PAT }}
        run: |
          # Fetch schedule.md
          SCHEDULE=$(curl -sH "Authorization: token $GH_TOKEN" \
            "https://raw.githubusercontent.com/takuya86/obsidian-sns-data/main/schedule.md")

          # Find today's post
          TODAY="${{ steps.date.outputs.today }}"
          LINE=$(echo "$SCHEDULE" | grep "^| $TODAY")

          if [ -z "$LINE" ]; then
            echo "No post scheduled for today ($TODAY)"
            echo "found=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Extract title from schedule line
          TITLE=$(echo "$LINE" | awk -F'|' '{print $3}' | xargs)
          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "found=true" >> $GITHUB_OUTPUT

      - name: Fetch captions
        if: steps.schedule.outputs.found == 'true'
        id: captions
        env:
          GH_TOKEN: ${{ secrets.DATA_REPO_PAT }}
        run: |
          TITLE="${{ steps.schedule.outputs.title }}"
          ENCODED_TITLE=$(python3 -c "import urllib.parse; print(urllib.parse.quote('$TITLE'))")

          # Fetch captions.md
          CAPTIONS=$(curl -sH "Authorization: token $GH_TOKEN" \
            "https://raw.githubusercontent.com/takuya86/obsidian-sns-data/main/videos/$ENCODED_TITLE/captions.md")

          # Extract platform-specific caption
          PLATFORM="${{ inputs.platform }}"

          if [ "$PLATFORM" = "tiktok" ]; then
            CAPTION=$(echo "$CAPTIONS" | sed -n '/## TikTok/,/## /p' | head -n -1 | tail -n +2)
          else
            CAPTION=$(echo "$CAPTIONS" | sed -n '/## Instagram/,/## /p' | head -n -1 | tail -n +2)
          fi

          # Store caption (handle multiline)
          {
            echo "caption<<EOF"
            echo "$CAPTION"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Send Slack notification
        if: steps.schedule.outputs.found == 'true'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          PLATFORM="${{ inputs.platform }}"
          TITLE="${{ steps.schedule.outputs.title }}"
          TODAY="${{ steps.date.outputs.today }}"
          CAPTION='${{ steps.captions.outputs.caption }}'

          if [ "$PLATFORM" = "tiktok" ]; then
            EMOJI="ðŸŽµ"
            TIME="12:00"
          else
            EMOJI="ðŸ“¸"
            TIME="19:00"
          fi

          # Build Slack message
          PAYLOAD=$(cat <<JSONEOF
          {
            "blocks": [
              {
                "type": "header",
                "text": {
                  "type": "plain_text",
                  "text": "$EMOJI $PLATFORM æŠ•ç¨¿æ™‚é–“ã§ã™ï¼",
                  "emoji": true
                }
              },
              {
                "type": "section",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": "*æ—¥ä»˜:*\n$TODAY"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*æŠ•ç¨¿æ™‚é–“:*\n$TIME JST"
                  }
                ]
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*ã‚¿ã‚¤ãƒˆãƒ«:*\n$TITLE"
                }
              },
              {
                "type": "divider"
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³:*\n\`\`\`$CAPTION\`\`\`"
                }
              },
              {
                "type": "context",
                "elements": [
                  {
                    "type": "mrkdwn",
                    "text": "ðŸ“ å‹•ç”»: <https://github.com/takuya86/obsidian-sns-data/blob/main/videos/$TITLE/$PLATFORM.mp4|GitHub ã§ç¢ºèª>"
                  }
                ]
              }
            ]
          }
          JSONEOF
          )

          curl -X POST -H 'Content-type: application/json' \
            --data "$PAYLOAD" \
            "$SLACK_WEBHOOK_URL"
