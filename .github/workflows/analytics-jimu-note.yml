name: note Analytics (jimu-ai)

on:
  workflow_dispatch:
  schedule:
    # ÊØéÊó• 9:00 JST (0:00 UTC)
    - cron: '0 0 * * *'

jobs:
  fetch-analytics:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout sns-scheduler
        uses: actions/checkout@v4

      - name: Checkout obsidian-sns-data
        uses: actions/checkout@v4
        with:
          repository: takuya86/obsidian-sns-data
          path: obsidian-sns-data
          token: ${{ secrets.DATA_REPO_PAT }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          npm install playwright
          npx playwright install chromium

      - name: Create cookie file
        run: |
          mkdir -p profiles/jimu-ai/cookies
          echo '${{ secrets.NOTE_COOKIES_JIMU_AI }}' > profiles/jimu-ai/cookies/note-session.json

      - name: Create analytics script
        run: |
          cat << 'SCRIPT' > sync-analytics.js
          const { chromium } = require('playwright');
          const fs = require('fs');
          const path = require('path');

          const profile = 'jimu-ai';
          const PERIODS = [
            { key: 'week', label: 'ÈÄ±Èñì', tabText: 'ÈÄ±' },
            { key: 'month', label: 'ÊúàÈñì', tabText: 'Êúà' },
            { key: 'year', label: 'Âπ¥Èñì', tabText: 'Âπ¥' },
            { key: 'all', label: 'ÂÖ®ÊúüÈñì', tabText: 'ÂÖ®ÊúüÈñì' }
          ];

          async function main() {
            const cookiesFile = `profiles/${profile}/cookies/note-session.json`;
            const cookies = JSON.parse(fs.readFileSync(cookiesFile, 'utf-8'));

            const browser = await chromium.launch({ headless: true });
            const context = await browser.newContext();
            await context.addCookies(cookies);
            const page = await context.newPage();

            const allData = { fetchedAt: new Date().toISOString(), profile, periods: {} };

            await page.goto('https://note.com/sitesettings/stats', { waitUntil: 'networkidle' });
            await page.waitForTimeout(3000);

            for (const period of PERIODS) {
              try {
                const tabs = await page.$$('button.btn');
                for (const tab of tabs) {
                  const text = await tab.innerText();
                  if (text.trim() === period.tabText) {
                    const isDisabled = await tab.isDisabled();
                    if (!isDisabled) {
                      await tab.click();
                      await page.waitForTimeout(2000);
                    }
                    break;
                  }
                }
              } catch (e) {}

              // Load all articles
              for (let i = 0; i < 20; i++) {
                try {
                  const moreButton = await page.$('button:has-text("„ÇÇ„Å£„Å®„Åø„Çã")');
                  if (!moreButton || !(await moreButton.isVisible())) break;
                  await moreButton.click();
                  await page.waitForTimeout(1000);
                } catch (e) { break; }
              }

              const summary = await page.evaluate(() => {
                const text = document.body.innerText;
                const viewMatch = text.match(/(\d[\d,]*)\s*ÂÖ®‰Ωì„Éì„É•„Éº/);
                const likesMatch = text.match(/(\d[\d,]*)\s*„Çπ„Ç≠/);
                return {
                  totalViews: viewMatch ? parseInt(viewMatch[1].replace(/,/g, ''), 10) : 0,
                  totalLikes: likesMatch ? parseInt(likesMatch[1].replace(/,/g, ''), 10) : 0
                };
              });

              const articles = await page.evaluate(() => {
                const results = [];
                document.querySelectorAll('table tbody tr, table tr').forEach(row => {
                  const cells = row.querySelectorAll('td, th');
                  if (cells.length < 3) return;
                  const titleText = cells[0].innerText.trim();
                  if (!titleText || titleText === 'Ë®ò‰∫ã') return;
                  const numbers = [];
                  for (let i = 1; i < cells.length; i++) {
                    const num = parseInt(cells[i].innerText.replace(/,/g, '').trim(), 10);
                    numbers.push(isNaN(num) ? 0 : num);
                  }
                  results.push({
                    title: titleText.replace(/\s*ÔºàÂâäÈô§Ê∏à„ÅøÔºâ.*$/, '').substring(0, 60),
                    views: numbers[0] || 0,
                    likes: numbers[2] || 0
                  });
                });
                return results;
              });

              allData.periods[period.key] = {
                label: period.label,
                totalViews: summary.totalViews,
                totalLikes: summary.totalLikes,
                articleCount: articles.length,
                top5: articles.sort((a, b) => b.views - a.views).slice(0, 5)
              };
            }

            await browser.close();
            console.log(JSON.stringify(allData, null, 2));
          }

          main().catch(e => {
            console.error('Error:', e.message);
            process.exit(1);
          });
          SCRIPT

      - name: Fetch analytics
        id: analytics
        run: |
          RESULT=$(node sync-analytics.js)
          echo "result<<EOF" >> $GITHUB_OUTPUT
          echo "$RESULT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Save to obsidian-sns-data
        if: success()
        run: |
          RESULT='${{ steps.analytics.outputs.result }}'
          DATE=$(TZ='Asia/Tokyo' date '+%Y-%m-%d')

          # Create analytics markdown
          cat << EOF > obsidian-sns-data/jimu-note/analytics.md
          # note„Ç¢„Éä„É™„ÉÜ„Ç£„ÇØ„Çπ

          Êõ¥Êñ∞Êó•: ${DATE}
          Ëá™ÂãïÁîüÊàê: GitHub Actions

          ---

          ## „Çµ„Éû„É™„Éº

          | ÊúüÈñì | Á∑è„Éì„É•„Éº | Á∑è„Çπ„Ç≠ |
          |------|----------|--------|
          | ÈÄ±Èñì | $(echo "$RESULT" | jq -r '.periods.week.totalViews') | $(echo "$RESULT" | jq -r '.periods.week.totalLikes') |
          | ÊúàÈñì | $(echo "$RESULT" | jq -r '.periods.month.totalViews') | $(echo "$RESULT" | jq -r '.periods.month.totalLikes') |
          | Âπ¥Èñì | $(echo "$RESULT" | jq -r '.periods.year.totalViews') | $(echo "$RESULT" | jq -r '.periods.year.totalLikes') |
          | ÂÖ®ÊúüÈñì | $(echo "$RESULT" | jq -r '.periods.all.totalViews') | $(echo "$RESULT" | jq -r '.periods.all.totalLikes') |

          ---

          ## ÈÄ±ÈñìTop5

          | È†Ü‰Ωç | „Çø„Ç§„Éà„É´ | „Éì„É•„Éº | „Çπ„Ç≠ |
          |------|---------|--------|------|
          | 1 | $(echo "$RESULT" | jq -r '.periods.week.top5[0].title') | $(echo "$RESULT" | jq -r '.periods.week.top5[0].views') | $(echo "$RESULT" | jq -r '.periods.week.top5[0].likes') |
          | 2 | $(echo "$RESULT" | jq -r '.periods.week.top5[1].title') | $(echo "$RESULT" | jq -r '.periods.week.top5[1].views') | $(echo "$RESULT" | jq -r '.periods.week.top5[1].likes') |
          | 3 | $(echo "$RESULT" | jq -r '.periods.week.top5[2].title') | $(echo "$RESULT" | jq -r '.periods.week.top5[2].views') | $(echo "$RESULT" | jq -r '.periods.week.top5[2].likes') |
          | 4 | $(echo "$RESULT" | jq -r '.periods.week.top5[3].title') | $(echo "$RESULT" | jq -r '.periods.week.top5[3].views') | $(echo "$RESULT" | jq -r '.periods.week.top5[3].likes') |
          | 5 | $(echo "$RESULT" | jq -r '.periods.week.top5[4].title') | $(echo "$RESULT" | jq -r '.periods.week.top5[4].views') | $(echo "$RESULT" | jq -r '.periods.week.top5[4].likes') |

          ---

          ## ÊúàÈñìTop5

          | È†Ü‰Ωç | „Çø„Ç§„Éà„É´ | „Éì„É•„Éº | „Çπ„Ç≠ |
          |------|---------|--------|------|
          | 1 | $(echo "$RESULT" | jq -r '.periods.month.top5[0].title') | $(echo "$RESULT" | jq -r '.periods.month.top5[0].views') | $(echo "$RESULT" | jq -r '.periods.month.top5[0].likes') |
          | 2 | $(echo "$RESULT" | jq -r '.periods.month.top5[1].title') | $(echo "$RESULT" | jq -r '.periods.month.top5[1].views') | $(echo "$RESULT" | jq -r '.periods.month.top5[1].likes') |
          | 3 | $(echo "$RESULT" | jq -r '.periods.month.top5[2].title') | $(echo "$RESULT" | jq -r '.periods.month.top5[2].views') | $(echo "$RESULT" | jq -r '.periods.month.top5[2].likes') |
          | 4 | $(echo "$RESULT" | jq -r '.periods.month.top5[3].title') | $(echo "$RESULT" | jq -r '.periods.month.top5[3].views') | $(echo "$RESULT" | jq -r '.periods.month.top5[3].likes') |
          | 5 | $(echo "$RESULT" | jq -r '.periods.month.top5[4].title') | $(echo "$RESULT" | jq -r '.periods.month.top5[4].views') | $(echo "$RESULT" | jq -r '.periods.month.top5[4].likes') |
          EOF

      - name: Commit to obsidian-sns-data
        if: success()
        run: |
          cd obsidian-sns-data
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add jimu-note/analytics.md
          git diff --staged --quiet || git commit -m "Update analytics $(TZ='Asia/Tokyo' date '+%Y-%m-%d')"
          git push

      - name: Send to Slack
        if: success()
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_JIMU }}
        run: |
          RESULT='${{ steps.analytics.outputs.result }}'

          # Parse JSON and create message
          WEEK_VIEWS=$(echo "$RESULT" | jq -r '.periods.week.totalViews')
          WEEK_LIKES=$(echo "$RESULT" | jq -r '.periods.week.totalLikes')
          MONTH_VIEWS=$(echo "$RESULT" | jq -r '.periods.month.totalViews')
          MONTH_LIKES=$(echo "$RESULT" | jq -r '.periods.month.totalLikes')
          ALL_VIEWS=$(echo "$RESULT" | jq -r '.periods.all.totalViews')
          ALL_LIKES=$(echo "$RESULT" | jq -r '.periods.all.totalLikes')

          # Get top 3 weekly articles
          TOP1=$(echo "$RESULT" | jq -r '.periods.week.top5[0] | "\(.title) (\(.views)PV)"')
          TOP2=$(echo "$RESULT" | jq -r '.periods.week.top5[1] | "\(.title) (\(.views)PV)"')
          TOP3=$(echo "$RESULT" | jq -r '.periods.week.top5[2] | "\(.title) (\(.views)PV)"')

          MESSAGE="üìä *Êó•Ê¨°„Ç¢„Éä„É™„ÉÜ„Ç£„ÇØ„Çπ„É¨„Éù„Éº„Éà*\n\n"
          MESSAGE+="*„Çµ„Éû„É™„Éº*\n"
          MESSAGE+="‚Ä¢ ÈÄ±Èñì: ${WEEK_VIEWS}PV / ${WEEK_LIKES}„Çπ„Ç≠\n"
          MESSAGE+="‚Ä¢ ÊúàÈñì: ${MONTH_VIEWS}PV / ${MONTH_LIKES}„Çπ„Ç≠\n"
          MESSAGE+="‚Ä¢ ÂÖ®ÊúüÈñì: ${ALL_VIEWS}PV / ${ALL_LIKES}„Çπ„Ç≠\n\n"
          MESSAGE+="*ÈÄ±ÈñìTop3*\n"
          MESSAGE+="1. ${TOP1}\n"
          MESSAGE+="2. ${TOP2}\n"
          MESSAGE+="3. ${TOP3}\n\n"
          MESSAGE+="üìà https://note.com/sitesettings/stats"

          curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\": \"$MESSAGE\"}" \
            "$SLACK_WEBHOOK"

      - name: Notify failure
        if: failure()
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_JIMU }}
        run: |
          MESSAGE="‚ö†Ô∏è *„Ç¢„Éä„É™„ÉÜ„Ç£„ÇØ„ÇπÂèñÂæóÂ§±Êïó*\n\n"
          MESSAGE+="note„ÅÆCookie„ÅåÂàá„Çå„ÅüÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ\n\n"
          MESSAGE+="*ÂØæÂøúÊâãÈ†Ü:*\n"
          MESSAGE+="1. note„Å´„É≠„Ç∞„Ç§„É≥„ÅóÁõ¥„Åô\n"
          MESSAGE+="2. Cookie„ÇíÂèñÂæó\n"
          MESSAGE+="3. GitHub Secrets „ÅÆ NOTE_COOKIES_JIMU_AI „ÇíÊõ¥Êñ∞\n\n"
          MESSAGE+="üîß https://github.com/takuya86/sns-scheduler/settings/secrets/actions"

          curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\": \"$MESSAGE\"}" \
            "$SLACK_WEBHOOK"
