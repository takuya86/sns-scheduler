name: X jimu-note Post Notification

on:
  workflow_dispatch:
    inputs:
      timing:
        description: 'Timing (morning/noon/evening)'
        required: true
        type: choice
        options:
          - morning
          - noon
          - evening

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Get current info (JST)
        id: info
        run: |
          # 曜日を取得（0=日曜, 1=月曜, ... 6=土曜）
          DOW=$(TZ='Asia/Tokyo' date '+%w')
          TODAY=$(TZ='Asia/Tokyo' date '+%Y-%m-%d')

          # 週番号（ポスト番号ローテーション用）
          WEEK_NUM=$(( ($(TZ='Asia/Tokyo' date '+%U') % 3) + 1 ))

          echo "dow=$DOW" >> $GITHUB_OUTPUT
          echo "today=$TODAY" >> $GITHUB_OUTPUT
          echo "week_num=$WEEK_NUM" >> $GITHUB_OUTPUT

          # 曜日名
          case $DOW in
            0) DOW_NAME="日曜" ;;
            1) DOW_NAME="月曜" ;;
            2) DOW_NAME="火曜" ;;
            3) DOW_NAME="水曜" ;;
            4) DOW_NAME="木曜" ;;
            5) DOW_NAME="金曜" ;;
            6) DOW_NAME="土曜" ;;
          esac
          echo "dow_name=$DOW_NAME" >> $GITHUB_OUTPUT

      - name: Determine post type and number
        id: post
        run: |
          DOW=${{ steps.info.outputs.dow }}
          TIMING="${{ inputs.timing }}"
          WEEK_NUM=${{ steps.info.outputs.week_num }}

          # 日曜の場合
          if [ "$DOW" = "0" ]; then
            if [ "$TIMING" = "noon" ]; then
              echo "type=改善_" >> $GITHUB_OUTPUT
              POST_NUM=$(( (2 + WEEK_NUM - 1) % 5 + 1 ))
              echo "num=$POST_NUM" >> $GITHUB_OUTPUT
              echo "time=12:00" >> $GITHUB_OUTPUT
              echo "stage=改善ログ" >> $GITHUB_OUTPUT
              echo "skip=false" >> $GITHUB_OUTPUT
            else
              echo "skip=true" >> $GITHUB_OUTPUT
            fi
            exit 0
          fi

          # ローテーション（新キャラ設計対応）:
          # 月: 1手(朝) / 教育(夜)
          # 火: 口癖(朝) / ビジョン(夜)
          # 水: 改善(朝) / 教育(夜)
          # 木: 1手(朝) / note誘導(夜)
          # 金: 愚痴(朝) / 確信(夜)
          # 土: テンプレ(朝) / 確信(夜)
          # 日: 改善(昼)

          # ポスト番号計算
          # 1手: 月朝・木朝 → 1手_1〜8
          # 口癖: 火朝 → 口癖_1〜8
          # 改善: 水朝・日昼 → 改善_1〜5
          # 愚痴: 金朝 → 愚痴_1〜4
          # テンプレ: 土朝 → テンプレ_1〜3
          # 教育: 月夜・水夜 → 教育1〜7
          # ビジョン: 火夜 → ビジョン1〜7
          # note誘導: 木夜 → note誘導1〜7
          # 確信: 金夜・土夜 → 確信1〜7

          # 週番号に応じたオフセット（7本ローテーション）
          case $WEEK_NUM in
            1) OFFSET=0 ;;
            2) OFFSET=3 ;;
            3) OFFSET=6 ;;
          esac

          case $DOW in
            1) # 月曜
              if [ "$TIMING" = "morning" ]; then
                echo "type=1手_" >> $GITHUB_OUTPUT
                echo "stage=会議後の1手" >> $GITHUB_OUTPUT
                echo "time=7:30" >> $GITHUB_OUTPUT
                POST_NUM=$(( (1 + OFFSET - 1) % 8 + 1 ))
              else
                echo "type=教育" >> $GITHUB_OUTPUT
                echo "stage=Stage3: 信頼" >> $GITHUB_OUTPUT
                echo "time=20:00" >> $GITHUB_OUTPUT
                POST_NUM=$(( (1 + OFFSET - 1) % 7 + 1 ))
              fi
              ;;
            2) # 火曜
              if [ "$TIMING" = "morning" ]; then
                echo "type=口癖_" >> $GITHUB_OUTPUT
                echo "stage=口癖シリーズ" >> $GITHUB_OUTPUT
                echo "time=7:30" >> $GITHUB_OUTPUT
                POST_NUM=$(( (1 + OFFSET - 1) % 8 + 1 ))
              else
                echo "type=ビジョン" >> $GITHUB_OUTPUT
                echo "stage=Stage2: 興味" >> $GITHUB_OUTPUT
                echo "time=20:00" >> $GITHUB_OUTPUT
                POST_NUM=$(( (1 + OFFSET - 1) % 7 + 1 ))
              fi
              ;;
            3) # 水曜
              if [ "$TIMING" = "morning" ]; then
                echo "type=改善_" >> $GITHUB_OUTPUT
                echo "stage=改善ログ" >> $GITHUB_OUTPUT
                echo "time=7:30" >> $GITHUB_OUTPUT
                POST_NUM=$(( (1 + OFFSET - 1) % 5 + 1 ))
              else
                echo "type=教育" >> $GITHUB_OUTPUT
                echo "stage=Stage3: 信頼" >> $GITHUB_OUTPUT
                echo "time=20:00" >> $GITHUB_OUTPUT
                POST_NUM=$(( (2 + OFFSET - 1) % 7 + 1 ))
              fi
              ;;
            4) # 木曜
              if [ "$TIMING" = "morning" ]; then
                echo "type=1手_" >> $GITHUB_OUTPUT
                echo "stage=会議後の1手" >> $GITHUB_OUTPUT
                echo "time=7:30" >> $GITHUB_OUTPUT
                POST_NUM=$(( (2 + OFFSET - 1) % 8 + 1 ))
              else
                echo "type=note誘導" >> $GITHUB_OUTPUT
                echo "stage=note導線" >> $GITHUB_OUTPUT
                echo "time=20:00" >> $GITHUB_OUTPUT
                POST_NUM=$(( (1 + OFFSET - 1) % 7 + 1 ))
              fi
              ;;
            5) # 金曜
              if [ "$TIMING" = "morning" ]; then
                echo "type=愚痴_" >> $GITHUB_OUTPUT
                echo "stage=愚痴供養" >> $GITHUB_OUTPUT
                echo "time=7:30" >> $GITHUB_OUTPUT
                POST_NUM=$(( (1 + OFFSET - 1) % 4 + 1 ))
              else
                echo "type=確信" >> $GITHUB_OUTPUT
                echo "stage=Stage4: 確信" >> $GITHUB_OUTPUT
                echo "time=20:00" >> $GITHUB_OUTPUT
                POST_NUM=$(( (1 + OFFSET - 1) % 7 + 1 ))
              fi
              ;;
            6) # 土曜
              if [ "$TIMING" = "morning" ]; then
                echo "type=テンプレ_" >> $GITHUB_OUTPUT
                echo "stage=テンプレ紹介" >> $GITHUB_OUTPUT
                echo "time=7:30" >> $GITHUB_OUTPUT
                POST_NUM=$(( (1 + OFFSET - 1) % 3 + 1 ))
              else
                echo "type=確信" >> $GITHUB_OUTPUT
                echo "stage=Stage4: 確信" >> $GITHUB_OUTPUT
                echo "time=20:00" >> $GITHUB_OUTPUT
                POST_NUM=$(( (2 + OFFSET - 1) % 7 + 1 ))
              fi
              ;;
          esac

          echo "num=$POST_NUM" >> $GITHUB_OUTPUT
          echo "skip=false" >> $GITHUB_OUTPUT

      - name: Fetch post content
        if: steps.post.outputs.skip != 'true'
        id: content
        env:
          GH_TOKEN: ${{ secrets.DATA_REPO_PAT }}
        run: |
          TYPE="${{ steps.post.outputs.type }}"
          NUM="${{ steps.post.outputs.num }}"

          # posts.mdを取得
          POSTS=$(curl -sH "Authorization: token $GH_TOKEN" \
            "https://raw.githubusercontent.com/takuya86/obsidian-sns-data/main/jimu-note/posts.md")

          # 該当するポストを抽出（### タイプN から次の ### または EOF まで）
          PATTERN="${TYPE}${NUM}"
          # ファイル末尾に対応するため、次の###またはファイル終端まで取得
          POST_CONTENT=$(echo "$POSTS" | awk "/### ${PATTERN}\$/{found=1; next} found && /^###/{exit} found{print}")

          # コードブロック内のテキストを抽出
          POST_TEXT=$(echo "$POST_CONTENT" | sed -n '/^```$/,/^```$/p' | sed '1d;$d')

          # GitHub Outputに保存
          {
            echo "text<<EOF"
            echo "$POST_TEXT"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Send Slack notification
        if: steps.post.outputs.skip != 'true'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_JIMU }}
        run: |
          TYPE="${{ steps.post.outputs.type }}"
          NUM="${{ steps.post.outputs.num }}"
          TIME="${{ steps.post.outputs.time }}"
          STAGE="${{ steps.post.outputs.stage }}"
          TODAY="${{ steps.info.outputs.today }}"
          DOW_NAME="${{ steps.info.outputs.dow_name }}"
          TIMING="${{ inputs.timing }}"
          POST_TEXT='${{ steps.content.outputs.text }}'

          # タイミングに応じたメッセージ
          if [ "$TIMING" = "morning" ]; then
            HEADER="朝の投稿準備"
            NOTE="前日夜に予約投稿してください"
          elif [ "$TIMING" = "noon" ]; then
            HEADER="昼の投稿時間"
            NOTE="今すぐ投稿してください"
          else
            HEADER="夜の投稿時間"
            NOTE="今すぐ投稿してください"
          fi

          # Slackメッセージ作成
          PAYLOAD=$(jq -n \
            --arg header "$HEADER" \
            --arg today "$TODAY" \
            --arg dow "$DOW_NAME" \
            --arg type "$TYPE" \
            --arg num "$NUM" \
            --arg time "$TIME" \
            --arg stage "$STAGE" \
            --arg text "$POST_TEXT" \
            --arg note "$NOTE" \
            '{
              blocks: [
                {
                  type: "header",
                  text: {
                    type: "plain_text",
                    text: "X \($header)",
                    emoji: true
                  }
                },
                {
                  type: "section",
                  fields: [
                    { type: "mrkdwn", text: "*日付:*\n\($today) (\($dow))" },
                    { type: "mrkdwn", text: "*投稿時間:*\n\($time)" }
                  ]
                },
                {
                  type: "section",
                  fields: [
                    { type: "mrkdwn", text: "*タイプ:*\n\($type)\($num)" },
                    { type: "mrkdwn", text: "*Stage:*\n\($stage)" }
                  ]
                },
                { type: "divider" },
                {
                  type: "section",
                  text: { type: "mrkdwn", text: "*投稿内容:*\n```\($text)```" }
                },
                {
                  type: "context",
                  elements: [
                    { type: "mrkdwn", text: "\($note)" }
                  ]
                }
              ]
            }')

          curl -s -X POST \
            -H "Content-type: application/json" \
            --data "$PAYLOAD" \
            "$SLACK_WEBHOOK_URL"

      - name: No post today
        if: steps.post.outputs.skip == 'true'
        run: |
          echo "No post scheduled for this timing"
